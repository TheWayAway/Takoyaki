<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline - Takoyaki</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Takoyaki Timeline</h1>
            <% if (isSuperAdmin) { %>
                <span class="admin-badge">Super Admin</span>
            <% } %>
        </div>
        <div class="header-right">
            <% if (isSuperAdmin) { %>
                <button id="add-event-btn" class="add-event-btn hidden">Add Event</button>
                <button id="edit-mode-btn" class="edit-mode-btn">Enable Edit Mode</button>
            <% } %>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </header>

    <main class="timeline-container">
        <% if (events.length === 0) { %>
            <p class="no-events">No events recorded yet.</p>
        <% } else { %>
            <div class="timeline-controls">
                <button id="sort-toggle-btn" class="sort-toggle-btn" data-sort="asc">
                    <span class="sort-label">Oldest First</span>
                    <span class="sort-icon">↑</span>
                </button>
            </div>
            <div class="timeline">
                <% events.forEach(event => { %>
                    <div class="timeline-event" data-event-id="<%= event.id %>" data-date="<%= event.event_date %>" data-time="<%= event.event_time || '' %>">
                        <div class="event-date"><%= event.event_date %><% if (event.event_time) { %> <%= event.event_time %><% } %></div>
                        <div class="event-content">
                            <div class="event-header">
                                <h3 class="event-title"><%= event.title %></h3>
                                <span class="event-id hidden">ID: <%= event.id %></span>
                            </div>
                            <% if (event.description) { %>
                                <p class="event-description"><%= event.description %></p>
                            <% } %>
                            <div class="event-actions hidden">
                                <button class="btn-edit" data-id="<%= event.id %>">Edit</button>
                                <button class="btn-delete" data-id="<%= event.id %>">Delete</button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>
    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h2>Edit Event</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id" name="id">
                <div class="form-group">
                    <label for="edit-date">Date</label>
                    <input type="date" id="edit-date" name="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="edit-title">Title</label>
                    <input type="text" id="edit-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" name="description" rows="4"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="edit-cancel">Cancel</button>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h2>Confirm Delete</h2>
            <p>Are you sure you want to delete this event?</p>
            <p class="delete-event-title"></p>
            <input type="hidden" id="delete-id">
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="delete-cancel">Cancel</button>
                <button type="button" class="btn-delete-confirm" id="delete-confirm">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h2>Add Event</h2>
            <form id="add-form">
                <div class="form-group">
                    <label for="add-date">Date</label>
                    <input type="date" id="add-date" name="eventDate">
                </div>
                <div class="form-group">
                    <label for="add-time">Time</label>
                    <input type="time" id="add-time" name="eventTime">
                </div>
                <div class="form-group">
                    <label for="add-title">Title</label>
                    <input type="text" id="add-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="add-description">Description</label>
                    <textarea id="add-description" name="description" rows="4"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="add-cancel">Cancel</button>
                    <button type="submit" class="btn-add">Add Event</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Sort toggle functionality (available to all users)
    (function() {
        const sortBtn = document.getElementById('sort-toggle-btn');
        const timeline = document.querySelector('.timeline');

        if (!sortBtn || !timeline) return;

        sortBtn.addEventListener('click', function() {
            const currentSort = this.dataset.sort;
            const newSort = currentSort === 'asc' ? 'desc' : 'asc';

            // Update button state
            this.dataset.sort = newSort;
            this.querySelector('.sort-label').textContent = newSort === 'asc' ? 'Oldest First' : 'Latest First';
            this.querySelector('.sort-icon').textContent = newSort === 'asc' ? '↑' : '↓';

            // Get all events and sort them
            const events = Array.from(timeline.querySelectorAll('.timeline-event'));

            events.sort((a, b) => {
                const dateA = a.dataset.date;
                const dateB = b.dataset.date;
                const timeA = a.dataset.time || '00:00';
                const timeB = b.dataset.time || '00:00';

                // Compare dates first
                if (dateA !== dateB) {
                    return newSort === 'asc'
                        ? dateA.localeCompare(dateB)
                        : dateB.localeCompare(dateA);
                }

                // If dates are equal, compare times
                return newSort === 'asc'
                    ? timeA.localeCompare(timeB)
                    : timeB.localeCompare(timeA);
            });

            // Re-append events in new order
            events.forEach(event => timeline.appendChild(event));
        });
    })();
    </script>
    <% if (isSuperAdmin) { %>
        <script src="/js/timeline.js"></script>
    <% } %>
</body>
</html>
